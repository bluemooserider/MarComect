<!DOCTYPE html>
<html>
<head>
    <title>Visual strategy Roadmap</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f1f5f9; font-family: 'Inter', sans-serif; }
        .gantt-container { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-top: 50px; }
        #chart_div { cursor: pointer; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="gantt-container mx-auto" style="max-width: 1400px;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div><h3 class="fw-bold m-0 text-primary">Execution Timeline</h3><p class="text-muted small m-0">Click any bar to view details</p></div>
                <button class="btn btn-sm btn-light border" onclick="window.close()">Close Window</button>
            </div>
            <div id="chart_div"></div>
        </div>
    </div>
    <script>
        google.charts.load('current', {'packages':['gantt']});
        google.charts.setOnLoadCallback(drawChart);

        let chart;
        let dataTable;

        function drawChart() {
            fetch('/api/gantt_data/{{ source_type }}/{{ source_id }}').then(r => r.json()).then(data => {
                dataTable = new google.visualization.DataTable();
                dataTable.addColumn('string', 'ID'); dataTable.addColumn('string', 'Name'); dataTable.addColumn('string', 'Resource');
                dataTable.addColumn('date', 'Start'); dataTable.addColumn('date', 'End'); dataTable.addColumn('number', 'Duration');
                dataTable.addColumn('number', 'Percent'); dataTable.addColumn('string', 'Dep');

                const rows = data.tasks.map(r => [r[0], r[1], r[2], new Date(r[3]), new Date(r[4]), r[5], r[6], r[7]]);
                if(rows.length) {
                    dataTable.addRows(rows);
                    chart = new google.visualization.Gantt(document.getElementById('chart_div'));

                    // Add Selection Listener
                    google.visualization.events.addListener(chart, 'select', onBarSelect);

                    chart.draw(dataTable, { height: rows.length * 45 + 100, gantt: { trackHeight: 45, barHeight: 30 } });
                }
            });
        }

        function onBarSelect() {
            const selection = chart.getSelection();
            if (selection.length > 0) {
                const rowIndex = selection[0].row;
                const fullId = dataTable.getValue(rowIndex, 0); // e.g., "TASK_12"
                const type = fullId.split('_')[0];
                const realId = fullId.split('_')[1];

                if(window.opener && !window.opener.closed) {
                    if(type === 'TASK') {
                        window.opener.openTaskModal(realId);
                        alert("Details opened in your main dashboard window.");
                    } else if(type === 'SPRINT') {
                        window.opener.loadTasks(realId, dataTable.getValue(rowIndex, 1));
                        alert("Sprint Roadmap opened in your main dashboard window.");
                    }
                } else {
                    alert(`Item ID: ${realId}\nType: ${type}\nNote: To open modals directly, please keep the dashboard tab open.`);
                }
            }
        }
    </script>
</body>
</html>