{% extends "base.html" %}
{% block content %}
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<style>
    :root { --brand-primary: #4f46e5; }
    .progress-micro { height: 4px; background-color: #e2e8f0; border-radius: 10px; overflow: hidden; margin-top: 8px; }
    .progress-micro-bar { height: 100%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
    #gantt_chart_div { width: 100%; min-height: 400px; cursor: pointer; }
    .asset-item { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
</style>

<div class="row g-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm p-3 bg-white" style="border-radius: 16px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-bold text-muted small m-0">STRATEGIES</h6>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="openGanttModal('all', 0)"><i class="bi bi-calendar3"></i></button>
                    <button class="btn btn-primary btn-sm rounded-circle" onclick="openCampaignModal()"><i class="bi bi-plus-lg"></i></button>
                </div>
            </div>
            <div class="list-group list-group-flush">
                {% for c in campaigns %}
                <div class="list-group-item list-group-item-action border-0 rounded-3 mb-2 p-3 campaign-item" onclick="loadSprints({{ c.id }}, this)" style="cursor:pointer; background: #f8fafc;">
                    <div class="fw-bold">{{ c.name }}</div>
                    <div class="progress-micro"><div class="progress-micro-bar bg-primary" id="camp-prog-{{ c.id }}" style="width: {{ c.get_progress() }}%"></div></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 16px;">
            <div class="card-header bg-white border-0 py-4 px-4 d-flex justify-content-between align-items-center">
                <h4 class="fw-bold m-0">Strategic Phases</h4>
                <div id="campaign-actions" class="d-none">
                    <button class="btn btn-outline-info btn-sm rounded-pill me-2 px-3" onclick="openGanttModal('campaign', activeCampId)"><i class="bi bi-calendar3 me-2"></i>Phase Gantt</button>
                    <button class="btn btn-dark btn-sm rounded-pill px-3" onclick="openSprintModal()"><i class="bi bi-plus-lg me-2"></i>Add Phase</button>
                </div>
            </div>
            <div class="card-body px-4 pb-4" id="sprint-grid"></div>
        </div>

        <div id="roadmap-panel" class="card border-0 shadow-sm d-none" style="border-radius: 16px; overflow: hidden;">
            <div class="card-header bg-primary text-white py-3 px-4 d-flex justify-content-between align-items-center border-0">
                <h6 class="fw-bold m-0 uppercase small">Roadmap: <span id="active-sprint-name" class="fw-light"></span></h6>
                <div class="d-flex gap-2">
                    <button class="btn btn-light btn-sm fw-bold shadow-sm rounded-pill px-3" onclick="openGanttModal('sprint', activeSprintId)"><i class="bi bi-calendar3 me-2"></i>Roadmap Gantt</button>
                    <button class="btn btn-light btn-sm fw-bold shadow-sm rounded-pill px-3" onclick="openTaskModal()">+ Add Action</button>
                </div>
            </div>
            <div class="card-body p-0" id="task-container"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="gantt-modal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-centered"><div class="modal-content border-0 shadow-lg" style="border-radius: 20px;"><div class="modal-body p-4"><div id="gantt_chart_div"></div></div></div></div></div>

<div class="modal fade" id="task-modal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
        <div class="modal-header border-0 pb-0 pt-4 px-4"><h5 class="fw-bold m-0">Action Item Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body p-4">
            <form id="task-form">
                <input type="hidden" id="t_id">
                <div class="row g-3">
                    <div class="col-md-7">
                        <input type="text" id="t_name" class="form-control mb-3 shadow-none" placeholder="Title" required>
                        <div class="row g-2 mb-3">
                            <div class="col"><label class="small fw-bold text-muted">START</label><input type="date" id="t_start" class="form-control shadow-none" required></div>
                            <div class="col"><label class="small fw-bold text-muted">DAYS</label><input type="number" id="t_dur" class="form-control shadow-none" value="1" required></div>
                        </div>
                        <textarea id="t_comments" class="form-control mb-3 shadow-none" rows="3" placeholder="Strategy Notes"></textarea>

                        <div class="p-3 border rounded bg-light">
                            <label class="small fw-bold text-primary mb-2">RESOURCES & FILES</label>
                            <div id="link-list" class="mb-2"></div>
                            <div id="file-list" class="mb-3"></div>

                            <div class="input-group input-group-sm mb-2">
                                <input type="text" id="new-link" class="form-control" placeholder="Add URL...">
                                <button class="btn btn-dark" type="button" onclick="addLink()">Link</button>
                            </div>
                            <div class="input-group input-group-sm">
                                <input type="file" id="new-file" class="form-control">
                                <button class="btn btn-dark" type="button" onclick="uploadFile()">Upload</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5 border-start">
                        <label class="small fw-bold text-primary mb-2">ASSIGNMENTS</label>
                        <div id="modal-groups" class="mb-3 overflow-auto" style="max-height: 120px;"></div>
                        <hr>
                        <div id="modal-users" class="overflow-auto" style="max-height: 120px;"></div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-4 shadow-sm">Save Changes</button>
            </form>
        </div>
    </div></div>
</div>

<script>
let activeCampId = null, activeSprintId = null, allUsers = [], allGroups = [];
google.charts.load('current', {'packages':['gantt']});

// DASHBOARD LOADING
function loadSprints(id, el) {
    activeCampId = id;
    document.querySelectorAll('.campaign-item').forEach(i => i.style.background = '#f8fafc');
    el.style.background = '#e0e7ff';
    document.getElementById('campaign-actions').classList.remove('d-none');
    fetchSprints();
}

function fetchSprints() {
    fetch(`/api/sprints/${activeCampId}`).then(r => r.json()).then(data => {
        let h = '<div class="row g-3">';
        data.forEach(s => {
            h += `<div class="col-md-4"><div class="card p-3 border rounded-4 shadow-sm" style="cursor:pointer" onclick="loadTasks(${s.id}, '${s.name}')">
                <h6 class="fw-bold m-0">${s.name}</h6>
                <div class="progress-micro"><div class="progress-micro-bar bg-success" style="width: ${s.progress}%"></div></div>
            </div></div>`;
        });
        document.getElementById('sprint-grid').innerHTML = h + '</div>';
    });
}

function loadTasks(id, name) {
    activeSprintId = id;
    document.getElementById('roadmap-panel').classList.remove('d-none');
    document.getElementById('active-sprint-name').innerText = name.toUpperCase();
    fetchTasks();
}

function fetchTasks() {
    fetch(`/api/tasks/${activeSprintId}`).then(r => r.json()).then(data => {
        let h = '<div class="list-group list-group-flush">';
        data.forEach(t => {
            let icon = t.is_completed ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted';
            h += `<div class="list-group-item d-flex align-items-center p-4 border-0 border-bottom">
                <i class="bi ${icon} h5 me-4" style="cursor:pointer" onclick="toggleTask(${t.id})"></i>
                <div class="flex-grow-1" onclick="openTaskModal(${t.id})" style="cursor:pointer">
                    <div class="fw-bold ${t.is_completed ? 'text-decoration-line-through opacity-50' : ''}">${t.name}</div>
                    <small class="text-muted">${t.assignee_names}</small>
                </div>
            </div>`;
        });
        document.getElementById('task-container').innerHTML = h + '</div>';
        refreshCampaignProgress();
    });
}

// ASSET MANAGEMENT
function renderLink(l) {
    document.getElementById('link-list').innerHTML += `<div class="asset-item"><a href="${l.url}" target="_blank" class="text-truncate" style="max-width:80%">${l.url}</a><i class="bi bi-x text-danger" style="cursor:pointer" onclick="delLink(${l.id})"></i></div>`;
}
function renderFile(f) {
    document.getElementById('file-list').innerHTML += `<div class="asset-item"><a href="/task/file/download/${f.id}">${f.filename}</a><i class="bi bi-x text-danger" style="cursor:pointer" onclick="delFile(${f.id})"></i></div>`;
}

function openTaskModal(tid = null) {
    const f = document.getElementById('task-form'); f.reset();
    document.getElementById('t_id').value = tid || '';
    document.getElementById('link-list').innerHTML = ''; document.getElementById('file-list').innerHTML = '';
    document.querySelectorAll('.g-chk, .u-chk').forEach(c => c.checked = false);
    if (tid) {
        fetch(`/api/task/${tid}`).then(r => r.json()).then(t => {
            document.getElementById('t_name').value = t.name; document.getElementById('t_start').value = t.start_date;
            document.getElementById('t_dur').value = t.duration_days; document.getElementById('t_comments').value = t.comments;
            document.querySelectorAll('.g-chk').forEach(cb => { if(t.group_ids.includes(parseInt(cb.value))) cb.checked = true; });
            updateUserFilter(t.user_ids);
            t.links.forEach(l => renderLink(l)); t.files.forEach(f => renderFile(f));
        });
    }
    new bootstrap.Modal(document.getElementById('task-modal')).show();
}

function addLink() {
    const tid = document.getElementById('t_id').value;
    if(!tid) return alert("Save task first.");
    fetch('/api/task/link/add', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({task_id: tid, url: document.getElementById('new-link').value})}).then(() => openTaskModal(tid));
}

function uploadFile() {
    const tid = document.getElementById('t_id').value;
    const f = document.getElementById('new-file').files[0];
    if(!tid || !f) return alert("Save task and select file.");
    const fd = new FormData(); fd.append('file', f); fd.append('task_id', tid);
    fetch('/api/task/file/upload', {method:'POST', body:fd}).then(() => openTaskModal(tid));
}

function delLink(id) { fetch('/api/task/link/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:id})}).then(() => openTaskModal(document.getElementById('t_id').value)); }
function delFile(id) { fetch('/api/task/file/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:id})}).then(() => openTaskModal(document.getElementById('t_id').value)); }

// GANTT MODAL
function openGanttModal(type, id) {
    new bootstrap.Modal(document.getElementById('gantt-modal')).show();
    document.getElementById('gantt-modal').addEventListener('shown.bs.modal', function () {
        fetch(`/api/gantt_data/${type}/${id}`).then(r => r.json()).then(data => {
            if (!data.tasks.length) return;
            const dt = new google.visualization.DataTable();
            dt.addColumn('string', 'ID'); dt.addColumn('string', 'Name'); dt.addColumn('string', 'Res');
            dt.addColumn('date', 'Start'); dt.addColumn('date', 'End'); dt.addColumn('number', 'Dur');
            dt.addColumn('number', 'Pct'); dt.addColumn('string', 'Dep');
            const rows = data.tasks.map(r => [r[0], r[1], r[2], new Date(r[3]), new Date(r[4]), r[5], r[6], r[7]]);
            dt.addRows(rows);
            const chart = new google.visualization.Gantt(document.getElementById('gantt_chart_div'));
            google.visualization.events.addListener(chart, 'select', function() {
                const sel = chart.getSelection();
                if (sel.length > 0) {
                    const row = sel[0].row; const fullId = dt.getValue(row, 0); const itemType = fullId.split('_')[0]; const realId = fullId.split('_')[1];
                    bootstrap.Modal.getInstance(document.getElementById('gantt-modal')).hide();
                    if (itemType === 'TASK') openTaskModal(realId);
                    else if (itemType === 'SPRINT') loadTasks(realId, dt.getValue(row, 1));
                }
            });
            chart.draw(dt, { height: rows.length * 45 + 100, gantt: { trackHeight: 45, barHeight: 30 } });
        });
    }, { once: true });
}

// UTILITIES
function toggleTask(id) { fetch('/api/task/complete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:id})}).then(() => { fetchTasks(); fetchSprints(); }); }
function refreshCampaignProgress() { fetch('/api/progress/campaigns').then(r => r.json()).then(d => { for(let id in d) { let el = document.getElementById(`camp-prog-${id}`); if(el) el.style.width = d[id] + '%'; } }); }

function updateUserFilter(selectedUsers = []) {
    const sgs = Array.from(document.querySelectorAll('.g-chk:checked')).map(cb => parseInt(cb.value));
    const uc = document.getElementById('modal-users'); uc.innerHTML = '';
    allUsers.filter(u => u.group_ids.some(gid => sgs.includes(gid))).forEach(u => {
        const ck = selectedUsers.includes(u.id) ? 'checked' : '';
        uc.innerHTML += `<div class="form-check"><input class="form-check-input u-chk" type="checkbox" value="${u.id}" ${ck}><label class="form-check-label small">${u.display_name}</label></div>`;
    });
}

// FORM HANDLERS
document.getElementById('task-form').onsubmit = (e) => {
    e.preventDefault();
    const data = { id: document.getElementById('t_id').value, sprint_id: activeSprintId, name: document.getElementById('t_name').value, start_date: document.getElementById('t_start').value, duration_days: document.getElementById('t_dur').value, comments: document.getElementById('t_comments').value, group_ids: Array.from(document.querySelectorAll('.g-chk:checked')).map(cb => cb.value), user_ids: Array.from(document.querySelectorAll('.u-chk:checked')).map(cb => cb.value) };
    fetch('/api/task/save', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) }).then(() => { bootstrap.Modal.getInstance(document.getElementById('task-modal')).hide(); fetchTasks(); fetchSprints(); });
};

document.addEventListener('DOMContentLoaded', () => {
    fetch('/api/users').then(r => r.json()).then(d => allUsers = d);
    fetch('/api/groups').then(r => r.json()).then(d => {
        allGroups = d; const gc = document.getElementById('modal-groups');
        d.forEach(g => { gc.innerHTML += `<div class="form-check"><input class="form-check-input g-chk" type="checkbox" value="${g.id}" onchange="updateUserFilter()"><label class="form-check-label small">${g.name}</label></div>`; });
    });
});
</script>
{% endblock %}