<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MarComect{% endblock %}</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root {
            --primary: #4f46e5;
            --primary-color: #4f46e5;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --bg-body: #f3f4f6;
            --surface: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --border-light: #e5e7eb;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; margin: 0; }
        .navbar { background-color: #eef2ff; border-bottom: 1px solid #c7d2fe; padding: 0.75rem 1.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        .navbar-brand { font-weight: 700; color: var(--primary) !important; letter-spacing: -0.5px; font-size: 1.25rem; transition: opacity 0.2s; }
        .navbar-brand:hover { opacity: 0.8; }
        .main-wrapper { flex: 1; padding: 20px; max-width: 1600px; margin: 0 auto; width: 100%; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .notification-icon { color: var(--primary); position: relative; font-size: 1.2rem; cursor: pointer; transition: color 0.2s; }
        .notification-icon:hover { color: #3730a3; }
        .notification-badge { font-size: 0.65rem; position: absolute; top: -5px; right: -5px; padding: 0.25em 0.5em; border: 2px solid #eef2ff; }
        .user-dropdown-toggle { cursor: pointer; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}" title="Go to Dashboard"><i class="bi bi-diagram-3-fill"></i> MarComect</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <div class="d-flex align-items-center gap-3 ms-auto">
                    {% if session.get('user_id') %}
                        <div class="position-relative me-2" onclick="openModal('notification-modal')" title="My Tasks">
                            <i class="bi bi-bell-fill notification-icon"></i>
                            {% if notification_count > 0 %}
                            <span class="badge rounded-pill bg-danger notification-badge">{{ notification_count }}</span>
                            {% endif %}
                        </div>

                        {% if session.get('role') == 'admin' %}
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-primary dropdown-toggle rounded-pill bg-white border-0 shadow-sm text-dark" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-shield-lock"></i> Admin
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-2 rounded-3">
                                <li><a class="dropdown-item py-2" href="#" onclick="openModal('group-management-modal'); loadGroups();"><i class="bi bi-collection me-2"></i> Group Management</a></li>
                                <li><a class="dropdown-item py-2" href="#" onclick="openModal('user-modal')"><i class="bi bi-people me-2"></i> User Management</a></li>
                                <li><a class="dropdown-item py-2" href="#" onclick="openModal('schedule-modal')"><i class="bi bi-clock me-2"></i> Backup Scheduler</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item py-2 text-danger" href="#" onclick="openModal('system-modal')"><i class="bi bi-hdd-network me-2"></i> System Tools</a></li>
                            </ul>
                        </div>
                        {% endif %}

                        <div class="d-flex align-items-center gap-2 border-start border-secondary ps-3">
                            <div class="dropdown">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center fw-bold shadow-sm user-dropdown-toggle" style="width:32px; height:32px; font-size:0.85rem;" title="{{ session.get('username') }}" data-bs-toggle="dropdown" aria-expanded="false">
                                    {{ session.get('username')[0]|upper }}
                                </div>
                                <ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-2 rounded-3">
                                    <li><h6 class="dropdown-header">Signed in as <b>{{ session.get('username') }}</b></h6></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="openModal('change-password-modal')"><i class="bi bi-key me-2"></i> Change Password</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
                                </ul>
                            </div>
                        </div>
                    {% else %}
                        <a href="{{ url_for('login') }}" class="btn btn-sm btn-primary rounded-pill px-4 fw-bold shadow-sm">Login</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    {% if session.get('user_id') %}
    <div class="modal fade" id="notification-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 bg-light">
                    <h5 class="modal-title fw-bold"><i class="bi bi-list-check text-primary me-2"></i>My Pending Tasks</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="list-group list-group-flush">
                        {% for task in my_pending_tasks %}
                        <div class="list-group-item p-3 d-flex align-items-center justify-content-between">
                            <div style="flex: 1; margin-right: 15px;">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1 fw-bold text-dark">{{ task.name }}</h6>
                                    <small class="text-muted">{{ task.start_date }}</small>
                                </div>
                                <small class="text-primary d-block mb-1"><i class="bi bi-folder2-open me-1"></i> {{ task.project.name }}</small>
                                <small class="text-muted">Type: {{ task.contractor_type }}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" title="Open Task" onclick="if(typeof editTask === 'function'){ editTask({{ task.id }}); bootstrap.Modal.getInstance(document.getElementById('notification-modal')).hide(); } else { window.location.reload(); }">
                                <i class="bi bi-box-arrow-up-right"></i> Open
                            </button>
                        </div>
                        {% else %}
                        <div class="p-4 text-center text-muted">
                            <i class="bi bi-check-circle display-4 text-success opacity-50"></i>
                            <p class="mt-2">You have no pending tasks.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="change-password-modal" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0"><h6 class="modal-title fw-bold">Change Password</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="change-password-form">
                        <input type="password" name="new_password" class="form-control mb-2" placeholder="New Password" required>
                        <input type="password" name="confirm_password" class="form-control mb-3" placeholder="Confirm Password" required>
                        <button type="submit" class="btn btn-dark w-100">Update Password</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmation-modal" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-body text-center p-4">
                    <div class="mb-3 text-warning"><i class="bi bi-exclamation-circle" style="font-size: 2rem;"></i></div>
                    <h6 class="fw-bold mb-2">Are you sure?</h6>
                    <p class="text-muted small mb-4" id="confirm-modal-message">This action cannot be undone.</p>
                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-sm btn-light border" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-sm btn-danger px-3" id="confirm-modal-btn">Yes, Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if session.get('role') == 'admin' %}
    <div class="modal fade" id="group-management-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">Group Management</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"><div class="row g-4"><div class="col-md-4 border-end"><div class="d-flex justify-content-between align-items-center mb-3"><h6 class="text-muted text-uppercase small fw-bold mb-0">Groups</h6><button class="btn btn-sm btn-outline-primary py-0" onclick="resetGroupForm()"><i class="bi bi-plus"></i> Add</button></div><div class="list-group list-group-flush" id="group-list-container" style="max-height: 400px; overflow-y: auto;"></div></div><div class="col-md-8"><h6 class="text-muted text-uppercase small fw-bold mb-3" id="group-form-title">Add New Group</h6><form id="group-management-form"><input type="hidden" name="id" id="gm_id"><div class="mb-3"><label class="small fw-bold">Group Name</label><input type="text" name="name" id="gm_name" class="form-control" placeholder="e.g. Sales" required></div><div class="mb-3"><label class="small fw-bold d-block mb-1">Assign Users</label><div class="border rounded p-2" style="max-height: 250px; overflow-y: auto;" id="gm_users_container"></div></div><div class="d-flex justify-content-between"><button type="button" class="btn btn-danger btn-sm" id="gm_delete_btn" style="display:none;" onclick="deleteGroup()">Delete Group</button><button type="submit" class="btn btn-primary w-100 ms-2" id="gm_save_btn">Create Group</button></div></form></div></div></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="user-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">User Management</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"><div class="row g-4"><div class="col-md-6 border-end"><h6 class="text-muted text-uppercase small fw-bold mb-3">Existing Users</h6><div class="list-group list-group-flush" id="user-list-group" style="max-height: 350px; overflow-y: auto;">{% for user in users %}<div class="list-group-item d-flex justify-content-between align-items-center px-0"><div><div class="fw-bold">{{ user.display_name }}</div><div class="small text-muted" style="font-size:0.75rem">{{ user.email if user.email else user.username }} ({{ user.role }})</div></div>{% if user.id != 1 %}<button class="btn btn-sm btn-outline-danger border-0" onclick="deleteUser({{ user.id }}, this)"><i class="bi bi-trash"></i></button>{% endif %}</div>{% endfor %}</div></div><div class="col-md-6"><h6 class="text-muted text-uppercase small fw-bold mb-3">Create User</h6><form id="add-user-form"><div class="row g-2 mb-2"><div class="col"><input type="text" name="first_name" class="form-control" placeholder="First Name"></div><div class="col"><input type="text" name="last_name" class="form-control" placeholder="Last Name"></div></div><div class="mb-2"><input type="email" name="email" class="form-control" placeholder="Email (Username)" required></div><div class="mb-2"><input type="password" name="password" class="form-control" placeholder="Password" required></div><div class="mb-3"><label class="small text-muted mb-1">Role</label><select name="role" class="form-select form-select-sm"><option value="user">User</option><option value="admin">Admin</option></select></div><div class="mb-3"><label class="small text-muted d-block mb-1">Assign Groups</label><div class="d-flex flex-wrap gap-2">{% for group in all_groups %}<div class="form-check"><input class="form-check-input" type="checkbox" name="group_ids" value="{{ group.id }}" id="u_{{group.id}}"><label class="form-check-label small" for="u_{{group.id}}">{{ group.name }}</label></div>{% endfor %}</div></div><button type="submit" class="btn btn-primary w-100">Create User</button></form></div></div></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="schedule-modal" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content border-0 shadow"><div class="modal-header border-0"><h6 class="modal-title fw-bold">Backup Scheduler</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="alert alert-light border small text-center mb-3">Status: <strong class="text-primary">{{ current_schedule }}</strong></div><form id="schedule-form"><div class="input-group mb-3"><input type="number" name="interval" class="form-control" value="24" min="1"><select name="unit" class="form-select" style="max-width: 80px;"><option value="hours">Hrs</option><option value="days">Day</option></select></div><button type="submit" class="btn btn-dark w-100">Update</button></form></div></div></div></div>
    <div class="modal fade" id="system-modal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow"><div class="modal-header border-0"><h6 class="modal-title fw-bold">System Maintenance</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="d-grid gap-3"><a href="{{ url_for('admin_backup_download') }}" class="btn btn-outline-dark text-start"><i class="bi bi-download me-2"></i> Download Backup</a><hr class="my-0"><form id="restore-form"><label class="small fw-bold mb-1">Restore DB</label><div class="input-group"><input type="file" name="db_file" class="form-control" accept=".db" required><button class="btn btn-warning" type="submit">Restore</button></div></form><hr class="my-0"><button class="btn btn-danger text-start" onclick="scrubDatabase()"><i class="bi bi-trash me-2"></i> Scrub Data</button></div></div></div></div></div>
    {% endif %}
    {% endif %}

    <div class="toast-container" id="toastContainer"></div>

    <div class="main-wrapper">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show shadow-sm border-0" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let confirmCallback = null;

        function showToast(message, type='success') {
            const container = document.getElementById('toastContainer');
            const bgClass = type === 'success' ? 'text-bg-success' : 'text-bg-danger';
            const toastHTML = `<div class="toast align-items-center ${bgClass} border-0 show shadow" role="alert"><div class="d-flex"><div class="toast-body fw-medium">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
            container.insertAdjacentHTML('beforeend', toastHTML);
            setTimeout(() => { if(container.lastElementChild) container.lastElementChild.remove(); }, 3000);
        }

        function openModal(id) { const el = document.getElementById(id); if(el) new bootstrap.Modal(el).show(); }

        window.openConfirmModal = function(message, callback) {
            document.getElementById('confirm-modal-message').innerText = message;
            confirmCallback = callback;
            new bootstrap.Modal(document.getElementById('confirmation-modal')).show();
        };

        const confirmBtn = document.getElementById('confirm-modal-btn');
        if(confirmBtn) {
            confirmBtn.addEventListener('click', function() {
                if(confirmCallback) confirmCallback();
                bootstrap.Modal.getInstance(document.getElementById('confirmation-modal')).hide();
            });
        }

        if(document.getElementById('change-password-form')) {
            document.getElementById('change-password-form').onsubmit = function(e) {
                e.preventDefault();
                const fd = new FormData(e.target);
                const data = Object.fromEntries(fd.entries());
                if(data.new_password !== data.confirm_password) { alert("Passwords do not match!"); return; }
                fetch('/api/user/change_password', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)})
                .then(r => r.json()).then(res => {
                    if(res.success) { showToast(res.message); bootstrap.Modal.getInstance(document.getElementById('change-password-modal')).hide(); e.target.reset(); }
                    else { alert(res.message); }
                });
            };
        }

        // --- GROUP MANAGEMENT LOGIC ---
        function loadGroups() {
            const container = document.getElementById('group-list-container');
            container.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
            fetch('/api/groups').then(r=>r.json()).then(data=>{
                container.innerHTML = '';
                data.forEach(g => {
                    container.innerHTML += `<button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="loadGroupDetails(${g.id})">${g.name} <i class="bi bi-chevron-right small text-muted"></i></button>`;
                });
            });
            fetch('/api/users').then(r=>r.json()).then(users=>{
                const uc = document.getElementById('gm_users_container');
                uc.innerHTML = '';
                users.forEach(u => {
                    uc.innerHTML += `<div class="form-check"><input class="form-check-input gm-user-chk" type="checkbox" name="user_ids" value="${u.id}" id="gm_u_${u.id}"><label class="form-check-label small" for="gm_u_${u.id}">${u.display_name} <span class="text-muted">(${u.email})</span></label></div>`;
                });
            });
            resetGroupForm();
        }

        function loadGroupDetails(id) {
            fetch(`/api/group/${id}`).then(r=>r.json()).then(data=>{
                document.getElementById('gm_id').value = data.id;
                document.getElementById('gm_name').value = data.name;
                document.getElementById('group-form-title').innerText = 'Edit Group';
                document.getElementById('gm_save_btn').innerText = 'Update Group';
                document.getElementById('gm_delete_btn').style.display = 'block';
                document.querySelectorAll('.gm-user-chk').forEach(chk => {
                    chk.checked = data.member_ids.includes(parseInt(chk.value));
                });
            });
        }

        function resetGroupForm() {
            document.getElementById('group-management-form').reset();
            document.getElementById('gm_id').value = '';
            document.getElementById('group-form-title').innerText = 'Add New Group';
            document.getElementById('gm_save_btn').innerText = 'Create Group';
            document.getElementById('gm_delete_btn').style.display = 'none';
            document.querySelectorAll('.gm-user-chk').forEach(chk => chk.checked = false);
        }

        function deleteGroup() {
            const id = document.getElementById('gm_id').value;
            if(!id) return;
            window.openConfirmModal('Delete this group? Users will remain, but group association removed.', () => {
                fetch('/api/group/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id: id}) })
                .then(r=>r.json()).then(res=>{
                    if(res.success) { showToast('Group deleted'); loadGroups(); }
                    else alert(res.message);
                });
            });
        }

        if(document.getElementById('group-management-form')) {
            document.getElementById('group-management-form').onsubmit = function(e) {
                e.preventDefault();
                const fd = new FormData(e.target);
                const data = Object.fromEntries(fd.entries());
                data.user_ids = fd.getAll('user_ids');
                fetch('/api/group/save', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) })
                .then(r=>r.json()).then(res=>{
                    if(res.success) { showToast('Group saved'); loadGroups(); }
                    else alert(res.message);
                });
            };
        }
    </script>
</body>
</html>